/*
This class also facilitates importing and working with the Java CDK.
*/

import org.gradle.api.Plugin
import org.gradle.api.Project
import org.gradle.api.tasks.testing.Test

class AirbyteJavaConnectorExtension {

    boolean useCdkProjectRef = false
    String cdkVersionRequired
    List<String> features = []  // e.g. 'db-sources', 'db-destinations'
    Project project

    AirbyteJavaConnectorExtension(Project project) {
        this.project = project
    }

    void addCdkDependencies() {
        project.dependencies {
            integrationTestJavaImplementation project
        }
        if (useCdkProjectRef) {
            project.dependencies {
                implementation project.project(":airbyte-cdk:java:airbyte-cdk:core")
                features.each { feature ->
                    implementation project.project(":airbyte-cdk:java:airbyte-cdk:${feature}-feature")
                    testImplementation testFixtures(project.project(":airbyte-cdk:java:airbyte-cdk:${feature}-feature"))
                    integrationTestJavaImplementation testFixtures(project.project(":airbyte-cdk:java:airbyte-cdk:${feature}-feature"))
                    performanceTestJavaImplementation testFixtures(project.project(":airbyte-cdk:java:airbyte-cdk:${feature}-feature"))
                }
            }
        } else {
            project.dependencies {
                implementation "io.airbyte:airbyte-cdk-core:${cdkVersionRequired}"
                features.each { feature ->
                    implementation ":airbyte-cdk:java:airbyte-cdk-${feature}:${cdkVersionRequired}"
                    testImplementation ":airbyte-cdk-${feature}-test-fixtures:${cdkVersionRequired}"
                    integrationTestJavaImplementation ":airbyte-cdk-${feature}-test-fixtures:${cdkVersionRequired}"
                    performanceTestJavaImplementation ":airbyte-cdk-${feature}-test-fixtures:${cdkVersionRequired}"
                }
            }
        }
    }
}


class AirbyteJavaConnectorPlugin implements Plugin<Project> {

    @Override
    void apply(Project project) {
        // def cdkTargetVersion = project.ext.getCdkTargetVersion(project)
        def extension = project.extensions.create('airbyteJavaConnector', AirbyteJavaConnectorExtension, project)

        project.plugins.apply(AirbyteJavaCdkPlugin)
        project.plugins.apply(AirbyteIntegrationTestJavaPlugin)
        project.plugins.apply(AirbytePerformanceTestJavaPlugin)
        project.plugins.apply(AirbyteConnectorAcceptanceTestPlugin)
    }
}
