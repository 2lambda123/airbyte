version: "0.29.0"

definitions:
  selector:
    extractor:
      field_path: ["entries"]
  requester:
    url_base: "https://api.chartmogul.com"
    http_method: "GET"
    authenticator:
      type: BasicHttpAuthenticator
      username: "{{ config['api_key'] }}"
  retriever:
    record_selector:
      $ref: "#/definitions/selector"
    requester:
      $ref: "#/definitions/requester"
  base_customer_count_stream:
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        request_body_data:
          start-date: "{{ format_datetime(config['start_date'], '%Y-%m-%d') }}"
          end-date: "{{ now_utc().strftime('%Y-%m-%d') }}"
          interval: "{{ parameters.interval }}"
      paginator:
        type: NoPagination
    $parameters:
      primary_key: "date"
      path: "/v1/metrics/customer-count"
  customers_stream:
    retriever:
      $ref: "#/definitions/retriever"
      paginator:
        type: DefaultPaginator
        pagination_strategy:
          type: "PageIncrement"
          start_from_page: 1
          page_size: 200
        page_size_option:
          inject_into: request_parameter
          field_name: per_page
        page_token_option:
          type: RequestOption
          inject_into: request_parameter
          field_name: page
    $parameters:
      name: "customers"
      primary_key: "id"
      path: "/v1/customers"
  activities_stream:
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          start-date: "{{ config.start_date }}"
      paginator:
        type: DefaultPaginator
        pagination_strategy:
          type: "CursorPagination"
          cursor_value: "{{ response['entries'][-1]['uuid'] }}"
          stop_condition: "{{ not response.has_more }}"
          page_size: 200
        page_size_option:
          inject_into: request_parameter
          field_name: per_page
        page_token_option:
          type: RequestOption
          inject_into: request_parameter
          field_name: start-after
    $parameters:
      name: "activities"
      primary_key: "uuid"
      path: "/v1/activities"
  customer_count_stream_daily:
    $ref: "#/definitions/base_customer_count_stream"
    $parameters:
      interval: "day"
      name: "customer_count_daily"
  customer_count_stream_weekly:
    $ref: "#/definitions/base_customer_count_stream"
    $parameters:
      interval: "week"
      name: "customer_count_weekly"
  customer_count_stream_monthly:
    $ref: "#/definitions/base_customer_count_stream"
    $parameters:
      interval: "month"
      name: "customer_count_monthly"
  customer_count_stream_quarterly:
    $ref: "#/definitions/base_customer_count_stream"
    $parameters:
      interval: "quarter"
      name: "customer_count_quarterly"

streams:
  - "#/definitions/customers_stream"
  - "#/definitions/activities_stream"
  - "#/definitions/customer_count_stream_daily"
  - "#/definitions/customer_count_stream_weekly"
  - "#/definitions/customer_count_stream_monthly"
  - "#/definitions/customer_count_stream_quarterly"

check:
  stream_names:
    - "customers"
