definitions:
  page_size: 50

  schema_loader:
    type: JsonSchema
    file_path: "./source_sendgrid/schemas/{{ options.name }}.json"
  result_selector:
    type: RecordSelector
    extractor:
      type: JelloExtractor
      transform: "_.result"
  results_selector:
    type: RecordSelector
    extractor:
      type: JelloExtractor
      transform: "_.results"
  selector:
    type: RecordSelector
    extractor:
      type: JelloExtractor
      transform: "_"
  requester:
    type: HttpRequester
    name: "{{ options['name'] }}"
    url_base: "https://api.sendgrid.com"
    http_method: "GET"
    authenticator:
      type: "BearerAuthenticator"
      token: "{{ config.apikey }}"
  cursor_paginator:
    type: LimitPaginator
    url_base: "*ref(definitions.requester.url_base)"
    page_size: "*ref(definitions.page_size)"
    limit_option:
      inject_into: "request_parameter"
      field_name: "page_size"
    page_token_option:
      inject_into: "path"
    pagination_strategy:
      type: "CursorPagination"
      cursor_value: "{{ response._metadata.next }}"
  offset_paginator:
    type: LimitPaginator
    $options:
      url_base: "*ref(definitions.requester.url_base)"
      page_size: "*ref(definitions.page_size)"
    limit_option:
      inject_into: "request_parameter"
      field_name: "limit"
    page_token_option:
      inject_into: "request_parameter"
      field_name: "offset"
    pagination_strategy:
      type: "OffsetIncrement"
  retriever:
    type: SimpleRetriever
    name: "{{ options['name'] }}"
    primary_key: "{{ options['primary_key'] }}"
  stream_slicer:
    type: "DatetimeStreamSlicer"
    start_datetime:
      datetime: "2017-01-01T00:00:00.0Z"
      datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
    end_datetime:
      datetime: "2022-08-01T00:00:00.0Z"
      datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
    step: "10000d"
    cursor_field: "created"
    start_time_option:
      field_name: "start_time"
      inject_into: "request_parameter"
    end_time_option:
      field_name: "end_time"
      inject_into: "request_parameter"
    datetime_format: "timestamp"

lists_stream:
  type: DeclarativeStream
  $options:
    name: "lists"
  primary_key: "id"
  schema_loader:
    $ref: "*ref(definitions.schema_loader)"
  retriever:
    $ref: "*ref(definitions.retriever)"
    record_selector:
      $ref: "*ref(definitions.result_selector)"
    requester:
      $ref: "*ref(definitions.requester)"
      path: "/v3/marketing/lists"
    paginator:
      $ref: "*ref(definitions.cursor_paginator)"
streams:
  - "*ref(lists_stream)"
check:
  type: CheckStream
  stream_names: ["lists"]
