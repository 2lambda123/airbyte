version: "0.1.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_pointer: ["{{ options.data_field or options.name }}"]
  requester:
    type: HttpRequester
    url_base: "https://api.twilio.com/"
    http_method: "GET"
    authenticator:
      type: BasicHttpAuthenticator
      username: "{{ config.account_sid }}"
      password: "{{ config.auth_token }}"
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "*ref(definitions.selector)"
    paginator:
      type: DefaultPaginator
      pagination_strategy:
        type: CursorPagination
        cursor_value: "{{ response['next_page_uri'] }}"
        page_size: 1000
      page_size_option:
        inject_into: "request_parameter"
        field_name: "PageSize"
      page_token_option:
        inject_into: "path"
      url_base: "*ref(definitions.requester.url_base)"
    requester:
      $ref: "*ref(definitions.requester)"
  boundary_request_parameters:
    request_parameters:
      "{{ options.lower_boundary_param }}": "{{ format_datetime(stream_slice.lower_boundary, options.boundary_format) }}"
      "{{ options.upper_boundary_param }}": "{{ format_datetime(stream_slice.upper_boundary, options.boundary_format) }}"
  datetime_slicer:
    type: DatetimeStreamSlicer
    stream_state_field_start: "lower_boundary"
    stream_state_field_end: "upper_boundary"
    start_datetime:
      datetime: "{{ config['start_date'] }}"
    end_datetime:
      datetime: "{{ now_utc().strftime('%Y-%m-%dT%H:%M:%SZ') }}"
    datetime_format: "%Y-%m-%dT%H:%M:%SZ"
    cursor_format: "%a, %d %b %Y %H:%M:%S %z"
    step: "{{ 'P' + config.slice_step_map[options.name]|string() + 'D' if config.slice_step_map[options.name] else options.step_default }}"
  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "*ref(definitions.retriever)"
  accounts_stream:
    $ref: "*ref(definitions.base_stream)"
    $options:
      name: "accounts"
      path: "/2010-04-01/Accounts.json"
      data_field: null
      primary_key: "sid"
  accounts_slicer:
    type: SubstreamSlicer
    parent_stream_configs:
      - stream: "*ref(definitions.accounts_stream)"
        parent_key: "/"
        stream_slice_field: "record"
  base_nested_stream:
    $ref: "*ref(definitions.base_stream)"
    retriever:
      $ref: "*ref(definitions.retriever)"
      requester:
        $ref: "*ref(definitions.requester)"
        path: "{{ stream_slice.record.subresource_uris[options.subresource_uri_key or options.name] }}"
      stream_slicer:
        $ref: "*ref(definitions.accounts_slicer)"
  addresses_stream:
    $ref: "*ref(definitions.base_nested_stream)"
    $options:
      name: "addresses"
      primary_key: "sid"
  applications_stream:
    $ref: "*ref(definitions.base_nested_stream)"
    $options:
      name: "applications"
      primary_key: "sid"
  incoming_phone_numbers_stream:
    $ref: "*ref(definitions.base_nested_stream)"
    $options:
      name: "incoming_phone_numbers"
      primary_key: "sid"
  keys_stream:
    $ref: "*ref(definitions.base_nested_stream)"
    $options:
      name: "keys"
      primary_key: "sid"
  outgoing_caller_ids_stream:
    $ref: "*ref(definitions.base_nested_stream)"
    $options:
      name: "outgoing_caller_ids"
      primary_key: "sid"
  transcriptions_stream:
    $ref: "*ref(definitions.base_nested_stream)"
    $options:
      name: "transcriptions"
      primary_key: "sid"
  available_phone_number_countries_stream:
    $ref: "*ref(definitions.base_nested_stream)"
    $options:
      name: "available_phone_number_countries"
      data_field: "countries"
      subresource_uri_key: "available_phone_numbers"
  queues_stream:
    $ref: "*ref(definitions.base_nested_stream)"
    $options:
      name: "queues"
      primary_key: "sid"
  base_phone_number_countries_stream:
    $ref: "*ref(definitions.base_stream)"
    retriever:
      $ref: "*ref(definitions.retriever)"
      requester:
        $ref: "*ref(definitions.requester)"
        path: "{{ stream_slice.path }}"
      stream_slicer:
        type: SubstreamSlicer
        parent_stream_configs:
          - stream: "*ref(definitions.available_phone_number_countries_stream)"
            parent_key: "subresource_uris/{{ options.subresource_uri_key }}"
            stream_slice_field: "path"
  available_phone_numbers_local_stream:
    $ref: "*ref(definitions.base_phone_number_countries_stream)"
    $options:
      name: "available_phone_numbers_local"
      data_field: "available_phone_numbers"
      subresource_uri_key: "local"
  available_phone_numbers_mobile_stream:
    $ref: "*ref(definitions.base_phone_number_countries_stream)"
    $options:
      name: "available_phone_numbers_mobile"
      data_field: "available_phone_numbers"
      subresource_uri_key: "mobile"
  available_phone_numbers_toll_free_stream:
    $ref: "*ref(definitions.base_phone_number_countries_stream)"
    $options:
      name: "available_phone_numbers_toll_free"
      data_field: "available_phone_numbers"
      subresource_uri_key: "toll_free"
  base_incremental_nested_stream:
    $ref: "*ref(definitions.base_stream)"
    retriever:
      $ref: "*ref(definitions.retriever)"
      requester:
        $ref: "*ref(definitions.requester)"
        path: "{{ stream_slice.record.subresource_uris[options.name] }}"
        request_options_provider:
          $ref: "*ref(definitions.boundary_request_parameters)"
      stream_slicer:
        type: CustomStreamSlicer
        class_name: source_twilio.components.TwilioCartesianProductStreamSlicer
        stream_slicers:
          - $ref: "*ref(definitions.accounts_slicer)"
          - $ref: "*ref(definitions.datetime_slicer)"
  # https://www.twilio.com/docs/voice/api/call-resource#read-multiple-call-resources
  calls_stream:
    $ref: "*ref(definitions.base_incremental_nested_stream)"
    $options:
      name: "calls"
      cursor_field: "end_time"
      lower_boundary_param: "EndTime>"
      upper_boundary_param: "EndTime<"
      boundary_format: "%Y-%m-%d"
      cursor_granularity: "P1D"
      step_default: "P1Y"
      primary_key: "sid"
    stream_cursor_field: "end_time"
  # https://www.twilio.com/docs/voice/api/conference-resource#read-multiple-conference-resources
  conferences_stream:
    $ref: "*ref(definitions.base_incremental_nested_stream)"
    $options:
      name: "conferences"
      cursor_field: "date_updated"
      lower_boundary_param: "DateUpdated>"
      upper_boundary_param: "DateUpdated<"
      boundary_format: "%Y-%m-%d"
      cursor_granularity: "P1D"
      step_default: "P1Y"
      primary_key: "sid"
    stream_cursor_field: "date_updated"
  # https://www.twilio.com/docs/sms/api/message-resource#read-multiple-message-resources
  messages_stream:
    $ref: "*ref(definitions.base_incremental_nested_stream)"
    $options:
      name: "messages"
      cursor_field: "date_sent"
      lower_boundary_param: "DateSent>"
      upper_boundary_param: "DateSent<"
      boundary_format: "%Y-%m-%dT%H:%M:%SZ"
      cursor_granularity: "PT0S"
      step_default: "P1D"
      primary_key: "sid"
    stream_cursor_field: "date_sent"
  # https://www.twilio.com/docs/voice/api/recording#read-multiple-recording-resources
  recordings_stream:
    $ref: "*ref(definitions.base_incremental_nested_stream)"
    $options:
      name: "recordings"
      cursor_field: "date_created"
      lower_boundary_param: "DateCreated>"
      upper_boundary_param: "DateCreated<"
      boundary_format: "%Y-%m-%dT%H:%M:%SZ"
      cursor_granularity: "PT0S"
      step_default: "P1Y"
      primary_key: "sid"
    stream_cursor_field: "date_created"
  # https://www.twilio.com/docs/usage/monitor-alert#read-multiple-alert-resources
  alerts_stream:
    $ref: "*ref(definitions.base_stream)"
    retriever:
      $ref: "*ref(definitions.retriever)"
      requester:
        $ref: "*ref(definitions.requester)"
        url_base: "https://monitor.twilio.com/"
        path: "/v1/Alerts"
        request_options_provider:
          $ref: "*ref(definitions.boundary_request_parameters)"
      stream_slicer:
        $ref: "*ref(definitions.datetime_slicer)"
    $options:
      name: "alerts"
      cursor_field: "date_generated"
      lower_boundary_param: "StartDate"
      upper_boundary_param: "EndDate"
      boundary_format: "%Y-%m-%dT%H:%M:%SZ"
      cursor_granularity: "PT0S"
      step_default: "P1Y"
      primary_key: "sid"
    stream_cursor_field: "date_generated"


streams:
  - "*ref(definitions.accounts_stream)"
  - "*ref(definitions.addresses_stream)"
  - "*ref(definitions.applications_stream)"
  - "*ref(definitions.incoming_phone_numbers_stream)"
  - "*ref(definitions.keys_stream)"
  - "*ref(definitions.outgoing_caller_ids_stream)"
  - "*ref(definitions.transcriptions_stream)"
  - "*ref(definitions.available_phone_number_countries_stream)"
  - "*ref(definitions.queues_stream)"
  - "*ref(definitions.available_phone_numbers_local_stream)"
  - "*ref(definitions.available_phone_numbers_mobile_stream)"
  - "*ref(definitions.available_phone_numbers_toll_free_stream)"
  - "*ref(definitions.calls_stream)"
  - "*ref(definitions.conferences_stream)"
  - "*ref(definitions.messages_stream)"
  - "*ref(definitions.recordings_stream)"
  - "*ref(definitions.alerts_stream)"

check:
  stream_names:
    - "accounts"
