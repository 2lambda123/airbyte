version: "0.29.0"

definitions:
  selector:
    extractor:
      field_path:
        - "{{ parameters['name'] }}"
  requester:
    url_base: "https://api.twilio.com/"
    http_method: "GET"
    authenticator:
      type: BasicHttpAuthenticator
      username: "{{ config['account_sid'] }}"
      password: "{{ config['auth_token'] }}"
  datetime_cursor:
    type: "DatetimeBasedCursor"
    start_datetime:
      datetime: "{{ config['start_date'] }}"
      datetime_format: "%Y-%m-%d"
    end_datetime:
      datetime: "{{ now_utc() }}"
      datetime_format: "%Y-%m-%d %H:%M:%S.%f+00:00"
    step: "P1D"
    datetime_format: "%Y-%m-%d"
    cursor_granularity: "P1D"
    lookback_window: "{{ config['lookback_window']}}"
    cursor_field: "date"
  retriever:
    record_selector:
      $ref: "#/definitions/selector"
    requester:
      $ref: "#/definitions/requester"
  default_paginator:
    type: "DefaultPaginator"
    page_size_option:
      inject_into: "request_parameter"
      field_name: "PageSize"
    pagination_strategy:
      type: "CursorPagination"
      cursor_value: "{{response['next_page_uri']}}"
      page_size: 50
    page_token_option:
      type: RequestPath
  base_stream:
    retriever:
      $ref: "#/definitions/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"

  accounts_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "accounts"
      path: "/Accounts.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        type: HttpRequester
        url_base: "https://api.twilio.com/2010-04-01"
        http_method: "GET"
        authenticator:
          type: BasicHttpAuthenticator
          username: "{{ config['account_sid'] }}"
          password: "{{ config['auth_token'] }}"

  accounts_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/accounts_stream"
        parent_key: sid
        partition_field: id

  addresses_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "addresses"
      path: "/Accounts/{{stream_interval.id}}/Addresses.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"

  addresses_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/addresses_stream"
        parent_key: sid
        partition_field: address_id

  dependent_phone_numbers_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "dependent_phone_numbers"
      path: "/Accounts/{{stream_partition.parent_slice.id}}/Addresses/{{stream_interval.address_id}}/DependentPhoneNumbers.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/addresses_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/addresses_partition_router"

  applications_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "applications"
      path: "Accounts/{{stream_interval.id}}/Applications.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"

  available_phone_number_countries_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "available_phone_number_countries"
      path: "Accounts/{{stream_interval.id}}/AvailablePhoneNumbers.json"
      primary_key: "country_code"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"

  available_phone_number_countries_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/available_phone_number_countries_stream"
        parent_key: "country_code"
        partition_field: country_code

  available_phone_numbers_local_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "available_phone_numbers_local"
      path: "/Accounts/{{stream_interval.parent_slice.id}}/AvailablePhoneNumbers/{{stream_interval.country_code}}/Local.json"
      primary_key: "iso_country"
    retriever:
      $ref: "#/definitions/available_phone_number_countries_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/available_phone_number_countries_partition_router"

  available_phone_numbers_mobile_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "available_phone_numbers_mobile"
      path: "/Accounts/{{stream_interval.parent_slice.id}}/AvailablePhoneNumbers/{{stream_interval.country_code}}/Mobile.json"
      primary_key: "iso_country"
    retriever:
      $ref: "#/definitions/available_phone_number_countries_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/available_phone_number_countries_partition_router"

  available_phone_numbers_toll_free_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "available_phone_numbers"
      path: "/Accounts/{{stream_interval.parent_slice.id}}/AvailablePhoneNumbers/{{stream_interval.country_code}}/TollFree.json"
      primary_key: "iso_country"
    retriever:
      $ref: "#/definitions/available_phone_number_countries_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/available_phone_number_countries_partition_router"

  calls_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "calls"
      path: "/Accounts/{{stream_interval.id}}/Calls.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "end_time"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"

  conferences_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "conferences"
      path: "/Accounts/{{stream_interval.id}}/Conferences.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "date_created"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"

  conferences_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/conferences_stream"
        parent_key: sid
        partition_field: conferences_id

  conference_participants_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "conference_participants"
      path: "/Accounts/{{stream_interval.parent_slice.id}}/Conferences/{{ stream_interval.conferences_id}}/Participants.json"
      primary_key: "conference_sid"
    retriever:
      $ref: "#/definitions/conferences_stream/retriever"
      record_selector:
        extractor:
          field_path: ["participants"]
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/conferences_partition_router"

  conversations_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "conversations"
      path: "/Conversations"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        type: HttpRequester
        url_base: "https://conversations.twilio.com/v1"
        http_method: "GET"
        authenticator:
          type: BasicHttpAuthenticator
          username: "{{ config['account_sid'] }}"
          password: "{{ config['auth_token'] }}"

  alerts_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "alerts"
      path: "/Alerts"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        type: HttpRequester
        url_base: "https://monitor.twilio.com/v1"
        http_method: "GET"
        authenticator:
          type: BasicHttpAuthenticator
          username: "{{ config['account_sid'] }}"
          password: "{{ config['auth_token'] }}"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "date_generated"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"
  conversations_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/conversations_stream"
        parent_key: sid
        partition_field: conversations_id

  conversation_messages_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "conversation_messages"
      path: "/Conversations/{{stream_interval.conversations_id}}/Messages"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/conversations_stream/retriever"
      record_selector:
        $ref: "#/definitions/selector"
        type: RecordSelector
        extractor:
          field_path:
            - "messages"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/conversations_partition_router"

  conversation_participants_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "conversation_participants"
      path: "/Conversations/{{stream_interval.conversations_id}}/Participants"
      primary_key: "sid"
    requester:
      url_base: "https://conversations.twilio.com/v1"
    retriever:
      $ref: "#/definitions/conversations_stream/retriever"
      record_selector:
        $ref: "#/definitions/selector"
        type: RecordSelector
        extractor:
          field_path:
            - "participants"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/conversations_partition_router"

  incoming_phone_numbers_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "incoming_phone_numbers"
      path: "/Accounts/{{stream_interval.id}}/IncomingPhoneNumbers.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"

  keys_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "keys"
      path: "/Accounts/{{stream_interval.id}}/Keys.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"

  messages_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "messages"
      path: "/Accounts/{{stream_interval.id}}/Messages.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "date_sent"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"

  messages_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/messages_stream"
        parent_key: sid
        partition_field: message_id

  message_media_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "message_media"
      path: "/Accounts/{{stream_interval.parent_slice.id}}/Messages/{{stream_interval.message_id}}/Media.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/messages_stream/retriever"
      record_selector:
        extractor:
          field_path: ["media_list"]
      record_filter:
        condition: "{{ stream_interval.message_id != '' }}"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/messages_partition_router"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "date_created"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"

  outgoing_caller_ids_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "outgoing_caller_ids"
      path: "/Accounts/{{stream_interval.id}}/OutgoingCallerIds.json"
      primary_key: ""
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"

  queues_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "queues"
      path: "/Accounts/{{stream_interval.id}}/Queues.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"

  recordings_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "recordings"
      path: "/Accounts/{{stream_interval.id}}/Recordings.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "date_created"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"

  transcriptions_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "transcriptions"
      path: "/Accounts/{{stream_interval.id}}/Transcriptions.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"

  usage_records_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "usage_records"
      path: "/Accounts/{{stream_interval.id}}/Usage/Records.json"
      primary_key:
        - "account_sid"
        - "category"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "start_date"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"

  usage_triggers_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "usage_triggers"
      path: "/Accounts/{{stream_interval.id}}/Usage/Triggers.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/accounts_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"

  flows_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "flows"
      primary_key: "sid"
      path: "/Flows"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        type: HttpRequester
        url_base: "https://studio.twilio.com/v1"
        http_method: "GET"
        authenticator:
          type: BasicHttpAuthenticator
          username: "{{ config['account_sid'] }}"
          password: "{{ config['auth_token'] }}"
      paginator:
        $ref: "#/definitions/default_paginator"

  flows_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/flows_stream"
        parent_key: sid
        partition_field: flow_id

  executions_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "executions"
      path: "/Flows/{{stream_interval.flow_id}}/Executions"
      primary_key: "sid"
    requester:
      url_base: "https://studio.twilio.com/v1"
    retriever:
      $ref: "#/definitions/flows_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/flows_partition_router"

  executions_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/executions_stream"
        parent_key: sid
        partition_field: execution_id

  step_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "step"
      path: "/Flows/{{stream_interval.parent_slice.flow_id}}/Executions/{{stream_interval.execution_id}}/Steps"
      primary_key: "sid"
    requester:
      url_base: "https://studio.twilio.com/v1"
    retriever:
      $ref: "#/definitions/executions_stream/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/executions_partition_router"

  services_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "services"
      path: "/Services"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        type: HttpRequester
        url_base: "https://chat.twilio.com/v2"
        http_method: "GET"
        authenticator:
          type: BasicHttpAuthenticator
          username: "{{ config['account_sid'] }}"
          password: "{{ config['auth_token'] }}"

  services_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/services_stream"
        parent_key: sid
        partition_field: service_id

  roles_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "roles"
      path: "/Services/{{stream_interval.service_id}}"
      primary_key: "service_sid"
    retriever:
      $ref: "#/definitions/services_stream/retriever"
      record_selector:
        $ref: "#/definitions/selector"
        type: RecordSelector
        extractor:
          field_path:
            - "services"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/users_partition_router"

  trunks_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "trunks"
      path: "/Trunks"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        type: HttpRequester
        url_base: "https://trunking.twilio.com/v1/"
        http_method: "GET"
        authenticator:
          type: BasicHttpAuthenticator
          username: "{{ config['account_sid'] }}"
          password: "{{ config['auth_token'] }}"

  verify_services_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "verify_services"
      path: "/Services"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/selector"
        type: RecordSelector
        extractor:
          field_path:
            - "services"
      paginator:
        $ref: "#/definitions/default_paginator"
        page_size: 100
      requester:
        type: HttpRequester
        url_base: "https://verify.twilio.com/v2/"
        http_method: "GET"
        authenticator:
          type: BasicHttpAuthenticator
          username: "{{ config['account_sid'] }}"
          password: "{{ config['auth_token'] }}"

  users_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "users"
      path: "/Users"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"
        page_size: 1000
      requester:
        type: HttpRequester
        url_base: "https://conversations.twilio.com/v1"
        http_method: "GET"
        authenticator:
          type: BasicHttpAuthenticator
          username: "{{ config['account_sid'] }}"
          password: "{{ config['auth_token'] }}"

  users_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/users_stream"
        parent_key: sid
        partition_field: user_sid

  user_conversations_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "user_conversations"
      path: "/Users/{{stream_interval.user_sid}}/Conversations"
      primary_key: "account_sid"
    retriever:
      $ref: "#/definitions/users_stream/retriever"
      record_selector:
        $ref: "#/definitions/selector"
        type: RecordSelector
        extractor:
          field_path:
            - "conversations"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/users_partition_router"

streams:
  - "#/definitions/accounts_stream"
  - "#/definitions/addresses_stream"
  - "#/definitions/alerts_stream"
  - "#/definitions/applications_stream"
  - "#/definitions/available_phone_number_countries_stream"
  - "#/definitions/available_phone_numbers_local_stream"
  - "#/definitions/available_phone_numbers_mobile_stream"
  - "#/definitions/available_phone_numbers_toll_free_stream"
  - "#/definitions/calls_stream"
  - "#/definitions/conference_participants_stream"
  - "#/definitions/conferences_stream"
  - "#/definitions/conversation_messages_stream"
  - "#/definitions/conversation_participants_stream"
  - "#/definitions/conversations_stream"
  - "#/definitions/dependent_phone_numbers_stream"
  - "#/definitions/flows_stream"
  - "#/definitions/executions_stream"
  - "#/definitions/incoming_phone_numbers_stream"
  - "#/definitions/keys_stream"
  - "#/definitions/message_media_stream"
  - "#/definitions/messages_stream"
  - "#/definitions/outgoing_caller_ids_stream"
  - "#/definitions/queues_stream"
  - "#/definitions/recordings_stream"
  - "#/definitions/transcriptions_stream"
  - "#/definitions/usage_records_stream"
  - "#/definitions/usage_triggers_stream"
  - "#/definitions/users_stream"
  - "#/definitions/user_conversations_stream"
  - "#/definitions/trunks_stream"
  - "#/definitions/roles_stream"
  - "#/definitions/services_stream"
  - "#/definitions/step_stream"
  - "#/definitions/verify_services_stream"

check:
  stream_names:
    - "accounts"
    - "addresses"
    - "dependent_phone_numbers"
    - "applications"
    - "calls"
    - "conferences"
    - "conversations"
    - "conversation_messages"
    - "conversation_participants"
    - "flows"
    - "incoming_phone_numbers"
    - "message_media"
    - "messages"
    - "outgoing_caller_ids"
    - "queues"
    - "recordings"
    - "roles"
    - "services"
    - "transcriptions"
    - "trunks"
    - "usage_records"
    - "usage_triggers"
    - "users"
    - "user_conversations"
    - "verify_services"

spec:
  type: Spec
  documentation_url: https://docs.airbyte.com/integrations/sources/twilio
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: Twilio Spec
    type: object
    required:
      - account_sid
      - auth_token
      - start_date
    additionalProperties: true
    properties:
      account_sid:
        title: Account ID
        description: Twilio account SID
        airbyte_secret: true
        type: string
        order: 1
      auth_token:
        title: Auth Token
        description: Twilio Auth Token.
        airbyte_secret: true
        type: string
        order: 2
      start_date:
        title: Replication Start Date
        description:
          UTC date and time in the format 2020-10-01T00:00:00Z. Any data
          before this date will not be replicated.
        pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
        examples:
          - "2020-10-01T00:00:00Z"
        type: string
        order: 3
        format: date-time
      lookback_window:
        title: Lookback window
        description: How far into the past to look for records. (in minutes)
        examples:
          - 60
        default: 0
        minimum: 0
        maximum: 576000
        type: integer
        order: 4
