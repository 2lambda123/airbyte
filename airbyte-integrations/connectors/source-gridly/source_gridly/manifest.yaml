version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: []

  requester:
    type: HttpRequester
    url_base: "https://api.gridly.com/v1/"
    http_method: "GET"
    authenticator:
      type: "ApiKeyAuthenticator"
      header: "Authorization"
      api_token: "ApiKey {{ config['api_key'] }}"

  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: NoPagination
    requester:
      $ref: "#/definitions/requester"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"

  views_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "views"
      primary_key: "id"
      # path: "views?gridId={{ config['grid_id'] }}"
      path: "views"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          gridId: "{{ config['grid_id'] }}"

  grids_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "grids"
      primary_key: "id"
      path: "grids/{{ config['grid_id'] }}"

  records_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/views_stream"
        parent_key: "id"
        partition_field: "parent_id"

  records_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "records"
      primary_key: "id"
      path: "views/{{ stream_partition.parent_id }}/records"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        $ref: "#/definitions/records_partition_router"


streams:
  - "#/definitions/views_stream"
  - "#/definitions/grids_stream"
  - "#/definitions/records_stream"

check:
  type: CheckStream
  stream_names:
    - "views"
    - "grids"
    - "records"
